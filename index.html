<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Branch League Forecast</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root {
    --primary: #02c719;
    --accent: #22c55e;
    --bg: #f1f5f9;
    --text: #1e293b;
    --card:
  }

  body {
    font-family: "Poppins", sans-serif;
    background: url('https://i.ibb.co.com/1GmfXNqG/fc.jpg') no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    color: var(--text);
  }

  .container {
    width: 100%;
    max-width: 900px;
    background: var(--card);
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    padding: 25px;
    backdrop-filter: blur(12px);
    animation: fadeIn 0.8s ease;
  }

  h1 {
    text-align: center;
    margin-bottom: 20px;
    font-weight: 700;
    color: var(--primary);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 40px;
    margin-bottom: 20px;
  }

  select, input {
  width: 100%;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid #cbd5e1;
  font-size: 15px;
  outline: none;
  transition: 0.3s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}


  select:focus, input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 5px var(--primary);
  }

  .dropdown {
    position: relative;
    width: 100%;
  }

  .dropdown-input {
    width: 100%;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #cbd5e1;
    font-size: 15px;
    outline: none;
    transition: 0.3s;
    cursor: pointer;
  }

  .dropdown-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 5px var(--primary);
  }

  .dropdown-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #cbd5e1;
    border-radius: 10px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  .dropdown-list li {
    padding: 10px 14px;
    cursor: pointer;
    list-style: none;
    border-bottom: 1px solid #f1f1f1;
  }

  .dropdown-list li:hover {
    background: #f8f9fa;
  }

  .dropdown-list li:last-child {
    border-bottom: none;
  }

  button {
    grid-column: 1 / -1;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }

  button:hover {
    background: var(--accent);
    transform: scale(1.03);
  }

  #chartContainer {
    display: none;
    margin-top: 25px;
    background: rgb(255, 255, 255);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }

  #summaryBox {
    display: none;
    margin-top: 25px;
    background: #e8f5e9;
    border-left: 6px solid var(--accent);
    border-radius: 10px;
    padding: 15px 20px;
    line-height: 1.7;
    font-size: 15px;
    animation: fadeIn 0.6s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 600px) {
    h1 { font-size: 20px; }
    .container { padding: 15px; }
    #summaryBox { font-size: 14px; }
  }
</style>
</head>

<body>

<div class="container">
  <h1>Branch League Forecast</h1>

  <div class="form-grid">
    <div class="dropdown">
      <input type="text" id="branchInput" class="dropdown-input" placeholder="Pilih Branch" oninput="filterBranches()" onclick="toggleDropdown()">
      <ul id="branchList" class="dropdown-list">
        <!-- 🔹 SUMATERA SELATAN -->
<li onclick="selectBranch('Palembang Sekip Jaya')">Palembang Sekip Jaya</li>
<li onclick="selectBranch('Palembang Sukodadi')">Palembang Sukodadi</li>
<li onclick="selectBranch('Palembang 8 Ulu')">Palembang 8 Ulu</li>
<li onclick="selectBranch('Palembang Sukamaju')">Palembang Sukamaju</li>
<li onclick="selectBranch('Palembang Karyajaya')">Palembang Karyajaya</li>
<li onclick="selectBranch('Palembang Kalidoni')">Palembang Kalidoni</li>
<li onclick="selectBranch('Palembang Talang Kelapa')">Palembang Talang Kelapa</li>

<li onclick="selectBranch('Banyuasin Pangkalan Balai')">Banyuasin Pangkalan Balai</li>
<li onclick="selectBranch('Banyuasin Betung')">Banyuasin Betung</li>
<li onclick="selectBranch('Banyuasin Sungsang')">Banyuasin Sungsang</li>

<li onclick="selectBranch('Musi Banyuasin Bayung Lencir')">Musi Banyuasin Bayung Lencir</li>
<li onclick="selectBranch('Musi Banyuasin Pangkalan Gresik')">Musi Banyuasin Pangkalan Gresik</li>
<li onclick="selectBranch('Musi Banyuasin Sungai Lilin')">Musi Banyuasin Sungai Lilin</li>

<li onclick="selectBranch('OKI Tugu Mulyo')">OKI Tugu Mulyo</li>
<li onclick="selectBranch('OKI Kayu Agung')">OKI Kayu Agung</li>

<!-- 🔹 LAMPUNG -->
<li onclick="selectBranch('Mesuji Tedunggeram')">Mesuji Tedunggeram</li>
<li onclick="selectBranch('Lampung Selatan Kalianda')">Lampung Selatan Kalianda</li>
<li onclick="selectBranch('Lampung Tengah Bandar Jaya')">Lampung Tengah Bandar Jaya</li>

<li onclick="selectBranch('Tulang Bawang Menggala')">Tulang Bawang Menggala</li>
<li onclick="selectBranch('Tulang Bawang Banjar Agung')">Tulang Bawang Banjar Agung</li>

<li onclick="selectBranch('Bandar Lampung Rajabasa')">Bandar Lampung Rajabasa</li>
<li onclick="selectBranch('Bandar Lampung Rawa Laut')">Bandar Lampung Rawa Laut</li>
<li onclick="selectBranch('Bandar Lampung Tanjung Senang')">Bandar Lampung Tanjung Senang</li>
<li onclick="selectBranch('Bandar Lampung Campang Raya')">Bandar Lampung Campang Raya</li>

<li onclick="selectBranch('Metro Hadimulyo Barat')">Metro Hadimulyo Barat</li>

<!-- 🔹 BANGKA BELITUNG -->
<li onclick="selectBranch('Bangka Barat Muntok')">Bangka Barat Muntok</li>
<li onclick="selectBranch('Bangka Barat Kelapa')">Bangka Barat Kelapa</li>
<li onclick="selectBranch('Bangka Sungai Liat')">Bangka Sungai Liat</li>
<li onclick="selectBranch('Pangkal Pinang Batin Tikal')">Pangkal Pinang Batin Tikal</li>

<!-- 🔹 JAMBI -->
<li onclick="selectBranch('Jambi Thehok')">Jambi Thehok</li>
<li onclick="selectBranch('Jambi Kenali Asam Bawah')">Jambi Kenali Asam Bawah</li>
<li onclick="selectBranch('Jambi Kenali Besar')">Jambi Kenali Besar</li>
<li onclick="selectBranch('Muaro Jambi Sengeti')">Muaro Jambi Sengeti</li>
<li onclick="selectBranch('Tanjung Jabung Barat Merlung')">Tanjung Jabung Barat Merlung</li>

<!-- 🔹 BENGKULU -->
<li onclick="selectBranch('Bengkulu Jembatan Kecil')">Bengkulu Jembatan Kecil</li>

      </ul>
    </div>

    <input type="number" id="targetInput" placeholder="Target League" min="1">
    <input type="number" id="netInput" placeholder="Net Subs Saat Ini" min="0">
    <input type="number" id="salesInput" placeholder="Jumlah Sales" min="1">
    <input type="date" id="dateInput">
    <button onclick="generateForecast()">Hitung Forecast</button>
  </div>

  <div id="chartContainer">
    <canvas id="forecastChart"></canvas>
  </div>

  <div id="summaryBox"></div>
</div>

<script>
let chart;
let selectedBranch = "";

// Load voices on page load
window.addEventListener('load', () => {
  speechSynthesis.getVoices();
});

function speakSummary(text) {
  const cleanText = text.replace(/<[^>]*>/g, '');
  const utterance = new SpeechSynthesisUtterance(cleanText);
  utterance.lang = 'id-ID';

  const voices = speechSynthesis.getVoices();
  let selectedVoice = null;

  // 1️⃣ Cari suara pria Indonesia yang mungkin terdengar tegas
  selectedVoice = voices.find(voice =>
    (voice.lang === 'id-ID' || voice.lang.startsWith('id')) &&
    (
      voice.name.toLowerCase().includes('male') ||
      voice.name.toLowerCase().includes('bapak') ||
      voice.name.toLowerCase().includes('wavenet-a') || // Suara Wavenet-A biasanya lebih tegas
      voice.name.toLowerCase().includes('indonesia')
    )
  );

  // 2️⃣ Kalau belum ketemu, ambil voice Indonesia apa pun
  if (!selectedVoice) {
    selectedVoice = voices.find(voice => voice.lang === 'id-ID' || voice.lang.startsWith('id'));
  }

  // 3️⃣ Fallback: ambil voice pertama
  if (!selectedVoice && voices.length > 0) {
    selectedVoice = voices[0];
  }

  if (selectedVoice) {
    utterance.voice = selectedVoice;
  }

  // --- MODIFIKASI: PENGATURAN KARAKTER LEBIH NATURAL (TETAP KERAS & TEGAS) ---
  utterance.pitch = 0.98;   // Sedikit lebih rendah dari normal (agar lebih berat/berwibawa)
  utterance.rate = 0.98;    // Lebih natural/tidak terlalu cepat (mendekati 1.0)
  utterance.volume = 1.0;   // Maksimal (tetap keras dan lantang)

  // Simulasi “bicara natural dan tegas” dengan jeda yang lebih santai
  const sentences = cleanText.split(/[.!?]/).filter(s => s.trim());
  speechSynthesis.cancel();

  sentences.forEach((sentence, index) => {
    const part = new SpeechSynthesisUtterance(sentence.trim());
    part.lang = utterance.lang;
    part.voice = utterance.voice;
    part.pitch = utterance.pitch;
    part.rate = utterance.rate;
    part.volume = utterance.volume;

    // Jeda sedikit lebih lama (misal: 300ms) untuk kesan bernapas dan lebih natural
    part.onend = () => {
      if (index < sentences.length - 1) {
        setTimeout(() => {}, 300); 
      }
    };

    speechSynthesis.speak(part);
  });
}






function toggleDropdown() {
  const list = document.getElementById("branchList");
  list.style.display = list.style.display === "block" ? "none" : "block";
}

function selectBranch(branch) {
  selectedBranch = branch;
  document.getElementById("branchInput").value = branch;
  document.getElementById("branchList").style.display = "none";
}

function filterBranches() {
  const input = document.getElementById("branchInput");
  const filter = input.value.toLowerCase();
  const list = document.getElementById("branchList");
  const items = list.getElementsByTagName("li");

  if (filter) {
    list.style.display = "block";
    for (let i = 0; i < items.length; i++) {
      const txtValue = items[i].textContent || items[i].innerText;
      if (txtValue.toLowerCase().indexOf(filter) > -1) {
        items[i].style.display = "";
      } else {
        items[i].style.display = "none";
      }
    }
  } else {
    list.style.display = "none";
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.querySelector('.dropdown');
  if (!dropdown.contains(event.target)) {
    document.getElementById("branchList").style.display = "none";
  }
});

function generateForecast() {
  const branch = selectedBranch;
  const target = parseInt(document.getElementById("targetInput").value);
  const net = parseInt(document.getElementById("netInput").value);
  const sales = parseInt(document.getElementById("salesInput").value);
  const selectedDate = document.getElementById("dateInput").value;

  if (!branch || !target || isNaN(net) || !sales || !selectedDate) {
    alert("eiitsss isi dulu dong!");
    return;
  }

  const today = new Date(selectedDate);
  const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
  const remainingDays = (lastDay - today) / (1000 * 60 * 60 * 24) + 1;

  const totalNeed = Math.max(target - net, 0);
  const perDay = totalNeed / remainingDays;
  const perSales = totalNeed / (remainingDays * sales);

  const sisaHari = Math.ceil(remainingDays);
  const data = new Array(sisaHari);

  // Distribute totalNeed across all days with integer values summing exactly to totalNeed
  const base = Math.floor(totalNeed / sisaHari);
  const remainder = totalNeed % sisaHari;

  // Initialize all days with base
  for (let i = 0; i < sisaHari; i++) {
    data[i] = base;
  }

  // Randomly select 'remainder' days to increment by 1
  const selectedDays = [];
  while (selectedDays.length < remainder) {
    const randomIndex = Math.floor(Math.random() * sisaHari);
    if (!selectedDays.includes(randomIndex)) {
      selectedDays.push(randomIndex);
    }
  }
  selectedDays.forEach(index => data[index]++);

  const labels = Array.from({length: sisaHari}, (_, i) => `Tgl ${today.getDate() + i}`);

  // Destroy chart lama
  if (chart) chart.destroy();

  document.getElementById("chartContainer").style.display = "block";

  const ctx = document.getElementById("forecastChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: `Forecast Harian (${branch})`,
        data: data,
        backgroundColor: "#22c55eaa",
        borderColor: "#16a34a",
        borderWidth: 1.5,
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: true },
        title: {
          display: true,
          text: `Forecast ${branch} (${sisaHari} hari tersisa)`,
          font: { size: 16, weight: "bold" }
        },
        datalabels: {
          color: "#000",
          anchor: "end",
          align: "top",
          font: { weight: "bold" },
          formatter: Math.round
        }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Subscriber / Hari/ Sales" } },
        x: { title: { display: true, text: "Tanggal" } }
      }
    },
    plugins: [{
      id: 'valueLabels',
      afterDatasetsDraw(chart) {
        const {ctx} = chart;
        chart.data.datasets.forEach((dataset, i) => {
          const meta = chart.getDatasetMeta(i);
          meta.data.forEach((bar, index) => {
            const val = dataset.data[index];
            ctx.fillStyle = "#000";
            ctx.font = "bold 12px Poppins";
            ctx.fillText(val, bar.x - 5, bar.y - 5);
          });
        });
      }
    }]
  });

  // Tentukan nama sapaan berdasarkan nama branch
let greeting = "";

switch (branch) {
  case "Palembang Sekip Jaya":
    greeting = "Hey Adam! Branch";
    break;
  case "Palembang Sukodadi":
    greeting = "Hey Chandri! Branch";
    break;
  case "Palembang Sukamaju":
    greeting = "Hey Tommy! Branch";
    break;
  case "Palembang 8 Ulu":
  case "Palembang Karya Jaya":
    greeting = "Hey Faisal! Branch";
    break;
  case "Palembang Kalidoni":
    greeting = "Hey Cesko! Branch";
    break;
  case "OKI Tugu Mulyo":
  case "OKI Kayu Agung":
    greeting = "Hey Muhammad Imam! Branch";
    break;
  case "Banyuasin Sungsang":
    greeting = "Hey Chandri! Branch";
    break;
  case "Banyuasin Pangkalan Balai":
  case "Banyuasin Betung":
    greeting = "Hey Haris! Branch";
    break;
  case "Musi Banyuasin Sungai Lilin":
  case "Musi Banyuasin Pangkalan Gresik":
  case "Musi Banyuasin Bayung Lencir":
    greeting = "Hey Gery! Branch";
    break;
  case "Jambi Thehok":
    greeting = "Hey Novianto!";
    break;
  case "Jambi Kenali Besar":
    greeting = "Hey Adi! Branch";
    break;
  case "Jambi Kenali Asam Bawah":
  case "Muaro Jambi Sengeti":
  case "Tanjung Jabung Barat Merlung":
    greeting = "Hey Cesco! Branch";
    break;
  case "Bandar Lampung Rawa Laut":
    greeting = "Hey Anam! Branch";
    break;
  case "Bandar Lampung Campang Raya":
    greeting = "Hey Yoga! Branch";
    break;
  case "Bandar Lampung Rajabasa":
    greeting = "Hey Bangga! Branch";
    break;
  case "Bandar Lampung Tanjung Senang":
    greeting = "Hey Tasil! Branch";
    break;
  case "Metro Hadimulyo Barat":
    greeting = "Hey Hakim! Branch";
    break;
  case "Lampung Selatan Kalianda":
    greeting = "Hey Bima! Branch";
    break;
  case "Lampung Tengah Bandar Jaya":
    greeting = "Hey Hakim! Branch";
    break;
  case "Mesuji Umbulan Tedunggeram":
  case "Tulang Bawang Menggala":
  case "Tulang Bawang Banjar Agung":
    greeting = "Hey Bobi! Branch";
    break;
  case "Bangka Barat Muntok":
  case "Pangkal Pinang Batin Tikal":
    greeting = "Hey Bayu! Branch";
    break;
  case "Bangka Sungai Liat":
  case "Bangka Barat Kelapa":
    greeting = "Hey Nuke Utami! Branch";
    break;
  case "Bengkulu Jembatan Kecil":
    greeting = "Hey Okiyaki! Branch";
    break;
  default:
    greeting = "Hey Team";
    break;
}

// Summary
const summary = `
  <b>${greeting} ${branch}</b> , net targetnya <b>${target}</b> pelanggan.<br>
  per hari ini sudah tercapai <b>${net}</b> pelanggan, jadi masih kurang <b>${totalNeed}</b> pelanggan.<br>
  Nah sisa <b>${sisaHari}</b> hari lagi, totalnya <b>${totalNeed}</b> pelanggan.<br>
  Dan lo punya <b>${sales}</b> Area Koordinator, berarti masing-masing Area Koordinator perlu closing minimal <b>${Math.ceil(perSales)}</b> Pelanggan per hari sampai akhir bulan, kalau masih jauh gap nya, lo coaching anaknya, kalau masih ga berubah lo lempar ke sungai musi.
`;


  const summaryBox = document.getElementById("summaryBox");
  summaryBox.style.display = "block";
  summaryBox.innerHTML = summary;

  // Speak the summary
  speakSummary(summary);
}
</script>

</body>
</html>
